CREATE PROCEDURE [dbo].[ProcedureGenerateOrder]
     @UserID INT,
    @OrderDate DATETIME = SYSDATETIME -- Domyślnie używamy bieżącej daty
AS
BEGIN
    SET NOCOUNT ON;

    -- Sprawdzamy, czy użytkownik ma jakieś produkty w koszyku
    IF EXISTS (SELECT 1 FROM BasketPosition WHERE UserID = @UserID)
    BEGIN
        -- Tworzymy nowe zamówienie dla użytkownika
        INSERT INTO [Order] (UserID, Date, isPayed)
        VALUES (@UserID, @OrderDate, 0)

        -- Pobieramy ID nowo utworzonego zamówienia
        DECLARE @OrderID INT
        SELECT @OrderID = SCOPE_IDENTITY()

        -- Przenosimy produkty z koszyka do nowego zamówienia
        INSERT INTO OrderPosition (OrderID, ProductID, Amount, Price)
        SELECT @OrderID, ProductID, Amount, Price
        FROM BasketPosition
        WHERE UserID = @UserID

        -- Usuwamy produkty z koszyka
        DELETE FROM BasketPosition WHERE UserID = @UserID

        PRINT 'Zamówienie zostało wygenerowane.'
    END
    ELSE
    BEGIN
        -- Jeśli użytkownik nie ma produktów w koszyku, wyświetlamy komunikat
        PRINT 'Nie można wygenerować zamówienia. Koszyk użytkownika jest pusty.'
    END
END;